{% extends "base.html" %}

{% block title %}Spravova≈• Darceky pre {{ child.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('admin_dashboard') }}" class="back-link">‚Üê Sp√§≈• na Spr√°vny Panel</a>
    <h1 class="page-title">Spravova≈• Darceky pre {{ child.name }}</h1>
    <a href="{{ url_for('admin_add_gift', child_id=child.id) }}" class="btn btn-primary">+ Prida≈• Darƒçek</a>
</div>

{% if child.gifts %}
    <div class="admin-table">
        <table class="table">
            <thead>
                <tr>
                    <th>Obr√°zok</th>
                    <th>N√°zov Darƒçeka</th>
                    <th>Popis</th>
                    <th>Stav</th>
                    <th>K√∫pil/a</th>
                    <th>Akcie</th>
                </tr>
            </thead>
            <tbody>
                {% for gift in child.gifts %}
                <tr class="{% if gift.is_purchased %}row-purchased{% endif %}">
                    <td class="gift-image-cell">
                        {% if gift.image_url %}
                            <img src="{{ gift.image_url }}" alt="{{ gift.name }}" class="gift-image-tile" onerror="this.style.display='none'">
                        {% else %}
                            <div class="gift-image-placeholder">üì¶</div>
                        {% endif %}
                    </td>
                    <td class="gift-name-cell">{{ gift.name }}</td>
                    <td class="description-cell">
                        {% if gift.description %}
                            {{ gift.description[:50] }}{% if gift.description|length > 50 %}...{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if gift.is_purchased %}
                            <span class="status-badge status-purchased">K√∫pen√©</span>
                        {% else %}
                            <span class="status-badge status-available">Dostupn√©</span>
                        {% endif %}
                    </td>
                    <td>{{ gift.purchased_by if gift.purchased_by else '-' }}</td>
                    <td class="actions-cell">
                        <a href="{{ url_for('admin_edit_gift', gift_id=gift.id) }}" class="btn btn-small btn-secondary">Upravi≈•</a>
                        {% if gift.is_purchased %}
                            <button type="button" class="btn btn-small btn-warning" onclick="showConfirmModal('unmark', {{ gift.id }}, '{{ gift.name }}')">Oznaƒçi≈• ako Nek√∫pen√©</button>
                        {% endif %}
                        <button type="button" class="btn btn-small btn-danger" onclick="showConfirmModal('delete', {{ gift.id }}, '{{ gift.name }}')">Vymaza≈•</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-icon">üéÅ</div>
        <h2>Zatiaƒæ ≈Ωiadne Darceky</h2>
        <p>Pridajte prv√Ω darƒçek do zoznamu {{ child.name }}</p>
        <a href="{{ url_for('admin_add_gift', child_id=child.id) }}" class="btn btn-primary">+ Prida≈• Darƒçek</a>
    </div>
{% endif %}

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Potvrdenie</h3>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="modalMessage"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Zru≈°i≈•</button>
            <button type="button" class="btn btn-primary" id="modalConfirmBtn" onclick="confirmAction()">Potvrdi≈•</button>
        </div>
    </div>
</div>

<script>
let currentAction = null;
let currentGiftId = null;
let currentGiftName = null;

function showConfirmModal(action, giftId, giftName) {
    currentAction = action;
    currentGiftId = giftId;
    currentGiftName = giftName;
    
    if (action === 'delete') {
        document.getElementById('modalTitle').textContent = 'Vymaza≈• darƒçek';
        document.getElementById('modalMessage').textContent = `Ste si ist√≠, ≈æe chcete vymaza≈• darƒçek "${giftName}"?`;
        document.getElementById('modalConfirmBtn').textContent = 'Vymaza≈•';
        document.getElementById('modalConfirmBtn').className = 'btn btn-danger';
    } else if (action === 'unmark') {
        document.getElementById('modalTitle').textContent = 'Oznaƒçi≈• ako nek√∫pen√©';
        document.getElementById('modalMessage').textContent = `Ste si ist√≠, ≈æe chcete oznaƒçi≈• darƒçek "${giftName}" ako nek√∫pen√Ω?`;
        document.getElementById('modalConfirmBtn').textContent = 'Oznaƒçi≈• ako nek√∫pen√©';
        document.getElementById('modalConfirmBtn').className = 'btn btn-warning';
    }
    
    showModal();
}

function confirmAction() {
    if (currentAction === 'delete') {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/gift/${currentGiftId}/delete`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    } else if (currentAction === 'unmark') {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/gift/${currentGiftId}/unmark`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
    closeModal();
}

function showModal() {
    document.getElementById('confirmModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
    currentAction = null;
    currentGiftId = null;
    currentGiftName = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}
