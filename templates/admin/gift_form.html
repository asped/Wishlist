{% extends "base.html" %}

{% block title %}{% if gift %}Upraviť Darček{% else %}Pridať Darček{% endif %} pre {{ child.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('admin_child_gifts', child_id=child.id) }}" class="back-link">← Späť na Darceky {{ child.name }}</a>
    <h1 class="page-title">{% if gift %}Upraviť Darček{% else %}Pridať Nový Darček{% endif %} pre {{ child.name }}</h1>
</div>

<div class="form-container">
    <form method="POST" class="form">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.name.label(class="form-label") }}
            {{ form.name(class="form-input", placeholder="napr. LEGO Vesmirna Stanica", required=true) }}
            {% if form.name.errors %}
                <div class="form-errors">
                    {% for error in form.name.errors %}
                        <span class="error">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-textarea", rows="4", placeholder="Pridajte detaily o darčeku, veľkosť, farbu, atď.") }}
            {% if form.description.errors %}
                <div class="form-errors">
                    {% for error in form.description.errors %}
                        <span class="error">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.link.label(class="form-label") }}
            {{ form.link(class="form-input", placeholder="https://priklad.sk/produkt") }}
            <p class="form-help">Pridajte odkaz na miesto, kde možno darček kúpiť</p>
            {% if form.link.errors %}
                <div class="form-errors">
                    {% for error in form.link.errors %}
                        <span class="error">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.link2.label(class="form-label") }}
            {{ form.link2(class="form-input", placeholder="https://priklad.cz/produkt") }}
            <p class="form-help">Pridajte druhý odkaz na miesto, kde možno darček kúpiť</p>
            {% if form.link2.errors %}
                <div class="form-errors">
                    {% for error in form.link2.errors %}
                        <span class="error">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.image_url.label(class="form-label") }}
            {{ form.image_url(class="form-input", placeholder="https://priklad.sk/obrazok.jpg") }}
            <p class="form-help">Pridajte odkaz na obrázok darčeka</p>
            <div class="image-fetch-feedback" id="image-fetch-feedback"></div>
            
            <!-- Iframe fallback interface -->
            <div class="iframe-fallback" id="iframe-fallback">
                <h4>Manuálny výber obrázka:</h4>
                <p class="form-help" style="margin-bottom: 15px; font-size: 14px; color: #666;">
                    Stránka produktu je zobrazená nižšie. Nájdite hlavný obrázok produktu a skopírujte jeho URL do poľa vyššie.
                </p>
                <div class="iframe-container">
                    <iframe id="product-iframe" src="" width="100%" height="500px" frameborder="0"></iframe>
                </div>
                <div class="iframe-actions">
                    <button type="button" class="btn btn-secondary" id="close-iframe">Zavrieť</button>
                </div>
            </div>
            {% if form.image_url.errors %}
                <div class="form-errors">
                    {% for error in form.image_url.errors %}
                        <span class="error">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.price_range.label(class="form-label") }}
            {{ form.price_range(class="form-input", placeholder="napr. 20-30 alebo približne 50") }}
            <p class="form-help">Pridajte približnú cenu alebo cenové rozpätie darčeka</p>
            {% if form.price_range.errors %}
                <div class="form-errors">
                    {% for error in form.price_range.errors %}
                        <span class="error">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-actions">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('admin_child_gifts', child_id=child.id) }}" class="btn btn-secondary">Zrušiť</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const link1Input = document.querySelector('input[name="link"]');
    const link2Input = document.querySelector('input[name="link2"]');
    const imageUrlInput = document.querySelector('input[name="image_url"]');
    const feedbackDiv = document.getElementById('image-fetch-feedback');
    const iframeFallbackDiv = document.getElementById('iframe-fallback');
    const productIframe = document.getElementById('product-iframe');
    const closeIframeBtn = document.getElementById('close-iframe');
    
    let fetchTimeout = null;
    
    function showFeedback(message, type) {
        feedbackDiv.textContent = message;
        feedbackDiv.className = `image-fetch-feedback ${type}`;
        feedbackDiv.style.display = 'block';
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                feedbackDiv.style.display = 'none';
            }, 5000);
        }
    }
    
    function hideFeedback() {
        feedbackDiv.style.display = 'none';
    }
    
    function hideIframeFallback() {
        iframeFallbackDiv.style.display = 'none';
        productIframe.src = '';
    }
    
    function showIframeFallback(productUrl) {
        productIframe.src = productUrl;
        iframeFallbackDiv.style.display = 'block';
    }
    
    function fetchImageFromUrl(url) {
        // Only fetch if image URL field is empty
        if (imageUrlInput.value.trim()) {
            return;
        }
        
        // Validate URL
        try {
            new URL(url);
        } catch {
            return;
        }
        
        // Show loading state
        showFeedback('Hľadám obrázok produktu...', 'loading');
        imageUrlInput.classList.add('fetching');
        
        // Make AJAX request
        fetch('/api/fetch-product-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({
                product_url: url
            })
        })
        .then(response => response.json())
        .then(data => {
            imageUrlInput.classList.remove('fetching');
            
            if (data.success) {
                if (data.iframe_fallback) {
                    // Show iframe fallback for blocked sites
                    showFeedback(data.message, 'success');
                    showIframeFallback(data.product_url);
                } else if (data.images && data.images.length > 0) {
                    // Single image found - auto-populate it
                    imageUrlInput.value = data.images[0];
                    imageUrlInput.classList.add('fetch-success');
                    showFeedback('Obrázok produktu bol úspešne nájdený!', 'success');
                    
                    setTimeout(() => {
                        imageUrlInput.classList.remove('fetch-success');
                    }, 2000);
                } else {
                    imageUrlInput.classList.add('fetch-error');
                    showFeedback('Obrázky produktu sa nepodarilo nájsť.', 'error');
                    
                    setTimeout(() => {
                        imageUrlInput.classList.remove('fetch-error');
                    }, 3000);
                }
            } else {
                imageUrlInput.classList.add('fetch-error');
                showFeedback('Chyba pri načítavaní obrázkov.', 'error');
                
                setTimeout(() => {
                    imageUrlInput.classList.remove('fetch-error');
                }, 3000);
            }
        })
        .catch(error => {
            imageUrlInput.classList.remove('fetching');
            imageUrlInput.classList.add('fetch-error');
            showFeedback('Chyba pri načítavaní obrázkov.', 'error');
            
            setTimeout(() => {
                imageUrlInput.classList.remove('fetch-error');
            }, 3000);
        });
    }
    
    function handleUrlInput(input) {
        const url = input.value.trim();
        
        // Clear existing timeout
        if (fetchTimeout) {
            clearTimeout(fetchTimeout);
        }
        
        // Hide any existing feedback and iframe
        hideFeedback();
        hideIframeFallback();
        
        // Only proceed if URL looks valid and image field is empty
        if (url && url.startsWith('http') && !imageUrlInput.value.trim()) {
            // Debounce: wait 1 second after user stops typing
            fetchTimeout = setTimeout(() => {
                fetchImageFromUrl(url);
            }, 1000);
        }
    }
    
    // Add event listeners to both link inputs
    if (link1Input) {
        link1Input.addEventListener('input', () => handleUrlInput(link1Input));
    }
    
    if (link2Input) {
        link2Input.addEventListener('input', () => handleUrlInput(link2Input));
    }
    
    // Close iframe button
    if (closeIframeBtn) {
        closeIframeBtn.addEventListener('click', function() {
            hideIframeFallback();
            hideFeedback();
        });
    }
    
    // Clear feedback when user manually edits image URL
    if (imageUrlInput) {
        imageUrlInput.addEventListener('input', () => {
            hideFeedback();
            hideIframeFallback();
            imageUrlInput.classList.remove('fetch-success', 'fetch-error');
        });
    }
});
</script>
{% endblock %}
