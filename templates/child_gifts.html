{% extends "base.html" %}

{% block title %}Zoznam Darƒçekov - {{ child.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-actions">
        <a href="{{ url_for('index') }}" class="btn btn-secondary back-btn">‚Üê Sp√§≈• na V≈°etky Deti</a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger logout-btn">Odhl√°si≈• sa</a>
    </div>
    <h1 class="page-title">Zoznam Darƒçekov - {{ child.name }}</h1>
    {% if child.age %}
    <p class="page-subtitle">Vek {{ child.age }}</p>
    {% endif %}
</div>

{% if child.gifts %}
    <div class="gifts-grid">
        {% for gift in child.gifts %}
        <div class="gift-tile {% if gift.is_purchased %}gift-purchased{% endif %}" data-gift-id="{{ gift.id }}">
            <div class="gift-tile-header">
                {% if gift.is_purchased %}
                    <span class="status-badge status-purchased">‚úì K√öPEN√â</span>
                {% else %}
                    <span class="status-badge status-available">DOSTUPN√â</span>
                {% endif %}
                <button class="close-btn" onclick="closeExpandedTile()" style="display: none;">√ó</button>
            </div>
            
            <div class="gift-tile-content" onclick="toggleGiftDetails({{ gift.id }})">
                {% if gift.image_url %}
                <div class="gift-tile-image">
                    <img src="{{ gift.image_url }}" alt="{{ gift.name }}" class="gift-image" onerror="this.style.display='none'">
                </div>
                {% else %}
                <div class="gift-tile-placeholder">
                    <span class="gift-icon">üéÅ</span>
                </div>
                {% endif %}
                
                <h3 class="gift-tile-name">{{ gift.name }}</h3>
                
                {% if gift.price_range %}
                <p class="gift-tile-price"><strong>Cena:</strong> {{ gift.price_range }} {{ gift.currency }}</p>
                {% endif %}
            </div>
            
            <div class="gift-details" id="details-{{ gift.id }}" style="display: none;">
                {% if gift.image_url %}
                <div class="gift-image-container">
                    <img src="{{ gift.image_url }}" alt="{{ gift.name }}" class="gift-image" onerror="this.style.display='none'">
                </div>
                {% endif %}

                {% if gift.description %}
                <p class="gift-description">{{ gift.description }}</p>
                {% endif %}

                {% if gift.price_range %}
                <p class="gift-price"><strong>Cena:</strong> {{ gift.price_range }} {{ gift.currency }}</p>
                {% endif %}

                {% if gift.link %}
                <div class="gift-link">
                    <a href="{{ gift.link }}" target="_blank" class="btn-link">üîó Zobrazi≈• Online</a>
                </div>
                {% endif %}

                {% if gift.link2 %}
                <div class="gift-link">
                    <a href="{{ gift.link2 }}" target="_blank" class="btn-link">üîó Alternat√≠vny Odkaz</a>
                </div>
                {% endif %}

                <div class="gift-actions">
                    {% if gift.is_purchased %}
                        <div class="purchased-info">
                            <p class="purchased-by">K√∫pil/a: <strong>{{ gift.purchased_by }}</strong></p>
                            <button type="button" class="btn btn-secondary" onclick="showConfirmModal('unmark', {{ gift.id }}, '{{ gift.name }}')">Zru≈°i≈• N√°kup</button>
                        </div>
                    {% else %}
                        <form method="POST" action="{{ url_for('purchase_gift', gift_id=gift.id) }}" class="purchase-form" onsubmit="return handlePurchase(this, {{ gift.id }}, '{{ gift.name }}');">
                            <label for="buyer_name_{{ gift.id }}" class="form-label">Va≈°e Meno:</label>
                            <input type="text" 
                                   id="buyer_name_{{ gift.id }}" 
                                   name="buyer_name" 
                                   class="form-input" 
                                   placeholder="Zadajte va≈°e meno"
                                   required>
                            <button type="submit" class="btn btn-success">K√∫pim Tento Darƒçek</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-icon">üéÅ</div>
        <h2>Zatiaƒæ ≈Ωiadne Darceky</h2>
        <p>Zoznam darƒçekov tohto die≈•a≈•a je pr√°zdny</p>
    </div>
{% endif %}

<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Potvrdenie</h3>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="modalMessage"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Zru≈°i≈•</button>
            <button type="button" class="btn btn-primary" id="modalConfirmBtn" onclick="confirmAction()">Potvrdi≈•</button>
        </div>
    </div>
</div>

<script>
let currentAction = null;
let currentGiftId = null;
let currentGiftName = null;
let currentForm = null;

function toggleGiftDetails(giftId) {
    const details = document.getElementById('details-' + giftId);
    const tile = document.querySelector(`[data-gift-id="${giftId}"]`);
    const closeBtn = tile.querySelector('.close-btn');
    
    // Close all other expanded tiles first
    const allTiles = document.querySelectorAll('.gift-tile');
    allTiles.forEach(t => {
        if (t !== tile) {
            t.classList.remove('expanded');
            const otherDetails = t.querySelector('.gift-details');
            const otherCloseBtn = t.querySelector('.close-btn');
            if (otherDetails) {
                otherDetails.style.display = 'none';
            }
            if (otherCloseBtn) {
                otherCloseBtn.style.display = 'none';
            }
        }
    });
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        tile.classList.add('expanded');
        closeBtn.style.display = 'flex';
        
        // Scroll the expanded tile into view
        setTimeout(() => {
            tile.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 100);
    } else {
        details.style.display = 'none';
        tile.classList.remove('expanded');
        closeBtn.style.display = 'none';
    }
}

function closeExpandedTile() {
    const expandedTile = document.querySelector('.gift-tile.expanded');
    if (expandedTile) {
        const details = expandedTile.querySelector('.gift-details');
        const closeBtn = expandedTile.querySelector('.close-btn');
        
        details.style.display = 'none';
        expandedTile.classList.remove('expanded');
        closeBtn.style.display = 'none';
    }
}

function handlePurchase(form, giftId, giftName) {
    const nameInput = form.querySelector('input[name="buyer_name"]');
    const name = nameInput.value.trim();
    
    if (!name) {
        showAlert('Pros√≠m, zadajte va≈°e meno');
        return false;
    }
    
    currentAction = 'purchase';
    currentGiftId = giftId;
    currentGiftName = giftName;
    currentForm = form;
    
    document.getElementById('modalTitle').textContent = 'Potvrdi≈• n√°kup';
    document.getElementById('modalMessage').textContent = `Ste si ist√≠, ≈æe chcete oznaƒçi≈• darƒçek "${giftName}" ako k√∫pen√Ω u≈æ√≠vateƒæom ${name}?`;
    document.getElementById('modalConfirmBtn').textContent = 'Potvrdi≈• n√°kup';
    document.getElementById('modalConfirmBtn').className = 'btn btn-success';
    
    showModal();
    return false;
}

function showConfirmModal(action, giftId, giftName) {
    currentAction = action;
    currentGiftId = giftId;
    currentGiftName = giftName;
    
    if (action === 'unmark') {
        document.getElementById('modalTitle').textContent = 'Zru≈°i≈• n√°kup';
        document.getElementById('modalMessage').textContent = `Ste si ist√≠, ≈æe chcete zru≈°i≈• oznaƒçenie darƒçeka "${giftName}" ako k√∫pen√Ω?`;
        document.getElementById('modalConfirmBtn').textContent = 'Zru≈°i≈• n√°kup';
        document.getElementById('modalConfirmBtn').className = 'btn btn-secondary';
    }
    
    showModal();
}

function confirmAction() {
    if (currentAction === 'purchase') {
        currentForm.submit();
    } else if (currentAction === 'unmark') {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/gift/${currentGiftId}/unmark`;
        document.body.appendChild(form);
        form.submit();
    }
    closeModal();
}

function showModal() {
    document.getElementById('confirmModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
    currentAction = null;
    currentGiftId = null;
    currentGiftName = null;
    currentForm = null;
}

function showAlert(message) {
    document.getElementById('modalTitle').textContent = 'Upozornenie';
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('modalConfirmBtn').textContent = 'OK';
    document.getElementById('modalConfirmBtn').className = 'btn btn-primary';
    document.getElementById('modalConfirmBtn').onclick = closeModal;
    showModal();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}
